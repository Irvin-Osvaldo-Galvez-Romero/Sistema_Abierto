// ==========================================
// Esquema de Base de Datos - Prisma ORM
// Sistema Universitario de Gestión Documental
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==========================================
// MODELOS DE AUTENTICACIÓN Y USUARIOS
// ==========================================

model Usuario {
  id                String              @id @default(uuid())
  email             String              @unique
  password          String
  nombre            String
  apellidoPaterno   String
  apellidoMaterno   String?
  telefono          String?
  rol               Rol                 @default(ESTUDIANTE)
  activo            Boolean             @default(true)
  emailVerificado   Boolean             @default(false)
  primerLogin       Boolean             @default(true)
  intentosFallidos  Int                 @default(0)
  bloqueadoHasta    DateTime?
  ultimoAcceso      DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relaciones
  estudiante        Estudiante?
  profesor          Profesor?
  administrador     Administrador?
  tokens            TokenSesion[]
  actividades       ActividadUsuario[]
  documentosCreados Documento[]         @relation("DocumentoCreador")
  creditosRevisados CreditoComplementario[] @relation("CreditosRevisados")
  pruebasRevisadas  PruebaModeloDual[]  @relation("PruebasRevisadas")
  formatosCreados   FormatoModeloDual[] @relation("FormatosCreados")
  conveniosCreados  ConvenioModeloDual[] @relation("ConveniosCreados")

  @@map("usuarios")
}

enum Rol {
  SUPER_ADMIN
  ADMINISTRADOR
  PROFESOR
  ESTUDIANTE
  PERSONAL_ADMINISTRATIVO
}

model TokenSesion {
  id             String   @id @default(uuid())
  token          String   @unique
  tipo           TipoToken
  expiraEn       DateTime
  revocado       Boolean  @default(false)
  ipAddress      String?
  userAgent      String?
  
  usuarioId      String
  usuario        Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())

  @@map("tokens_sesion")
}

enum TipoToken {
  ACCESS
  REFRESH
  RESET_PASSWORD
  VERIFY_EMAIL
  VERIFICATION_CODE
}

// ==========================================
// MODELOS DE ESTUDIANTES
// ==========================================

model Estudiante {
  id                String              @id @default(uuid())
  matricula         String              @unique
  fechaNacimiento   DateTime?
  curp              String?             @unique
  nss               String?
  direccion         String?
  ciudad            String?
  estado            String?
  codigoPostal      String?
  tutorNombre       String?
  tutorTelefono     String?
  tutorEmail        String?
  estatus           EstatusEstudiante   @default(ACTIVO)
  fechaIngreso      DateTime            @default(now())
  fechaEgreso       DateTime?
  
  usuarioId         String              @unique
  usuario           Usuario             @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  carreraId         String?
  carrera           Carrera?            @relation(fields: [carreraId], references: [id])
  
  // Relaciones
  inscripciones     Inscripcion[]
  calificaciones    Calificacion[]
  documentos        DocumentoEstudiante[]
  notificaciones    Notificacion[]
  creditos          CreditoComplementario[]
  pruebasModeloDual PruebaModeloDual[]
  modeloDual        EstudianteModeloDual?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("estudiantes")
}

enum EstatusEstudiante {
  ACTIVO
  INACTIVO
  EGRESADO
  BAJA_TEMPORAL
  BAJA_DEFINITIVA
}

// ==========================================
// MODELOS ACADÉMICOS
// ==========================================

model Carrera {
  id                String        @id @default(uuid())
  clave             String        @unique
  nombre            String
  descripcion       String?
  duracionSemestres Int
  creditos          Int
  modalidad         Modalidad
  activo            Boolean       @default(true)
  
  // Relaciones
  estudiantes       Estudiante[]
  materias          Materia[]
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@map("carreras")
}

enum Modalidad {
  PRESENCIAL
  EN_LINEA
  MIXTA
}

model Materia {
  id              String            @id @default(uuid())
  clave           String            @unique
  nombre          String
  descripcion     String?
  creditos        Int
  semestre        Int
  horasTeoria     Int
  horasPractica   Int
  activo          Boolean           @default(true)
  
  carreraId       String
  carrera         Carrera           @relation(fields: [carreraId], references: [id])
  
  // Relaciones
  grupos          Grupo[]
  calificaciones  Calificacion[]
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@map("materias")
}

model Grupo {
  id              String        @id @default(uuid())
  clave           String        @unique
  periodo         String
  cupoMaximo      Int
  cupoDisponible  Int
  horario         String
  aula            String?
  activo          Boolean       @default(true)
  
  materiaId       String
  materia         Materia       @relation(fields: [materiaId], references: [id])
  
  profesorId      String
  profesor        Profesor      @relation(fields: [profesorId], references: [id])
  
  // Relaciones
  inscripciones   Inscripcion[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("grupos")
}

model Inscripcion {
  id              String              @id @default(uuid())
  periodo         String
  estatus         EstatusInscripcion  @default(INSCRITO)
  fechaInscripcion DateTime           @default(now())
  
  estudianteId    String
  estudiante      Estudiante          @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  
  grupoId         String
  grupo           Grupo               @relation(fields: [grupoId], references: [id])
  
  // Relaciones
  calificacion    Calificacion?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([estudianteId, grupoId, periodo])
  @@map("inscripciones")
}

enum EstatusInscripcion {
  INSCRITO
  CURSANDO
  APROBADO
  REPROBADO
  BAJA
}

model Calificacion {
  id              String    @id @default(uuid())
  calificacion    Float
  estatus         String
  observaciones   String?
  
  estudianteId    String
  estudiante      Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  
  materiaId       String
  materia         Materia   @relation(fields: [materiaId], references: [id])
  
  inscripcionId   String    @unique
  inscripcion     Inscripcion @relation(fields: [inscripcionId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("calificaciones")
}

// ==========================================
// MODELOS DE PROFESORES Y PERSONAL
// ==========================================

model Profesor {
  id              String    @id @default(uuid())
  numeroEmpleado  String    @unique
  especialidad    String?
  grado           String?
  departamento    String?
  activo          Boolean   @default(true)
  
  usuarioId       String    @unique
  usuario         Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  // Relaciones
  grupos          Grupo[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("profesores")
}

model Administrador {
  id              String    @id @default(uuid())
  numeroEmpleado  String    @unique
  area            String?
  cargo           String?
  activo          Boolean   @default(true)
  
  usuarioId       String    @unique
  usuario         Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("administradores")
}

// ==========================================
// MODELOS DE GESTIÓN DOCUMENTAL
// ==========================================

model Documento {
  id                String              @id @default(uuid())
  folio             String              @unique
  tipo              TipoDocumento
  titulo            String
  descripcion       String?
  rutaArchivo       String
  rutaArchivoFirmado String?
  hashArchivo       String
  tamanoBytes       Int
  mimeType          String
  estatus           EstatusDocumento    @default(PENDIENTE)
  fechaEmision      DateTime?
  fechaVencimiento  DateTime?
  validado          Boolean             @default(false)
  firmado           Boolean             @default(false)
  cadenaBlockchain  String?
  qrCode            String?
  
  creadoPorId       String
  creadoPor         Usuario             @relation("DocumentoCreador", fields: [creadoPorId], references: [id])
  
  // Relaciones
  documentosEstudiante DocumentoEstudiante[]
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("documentos")
}

enum TipoDocumento {
  KARDEX
  FICHA_REINSCRIPCION
  COMPROBANTE_PAGO
}

enum EstatusDocumento {
  PENDIENTE
  EN_REVISION
  APROBADO
  RECHAZADO
  VENCIDO
  ANULADO
}

model DocumentoEstudiante {
  id                  String     @id @default(uuid())
  observaciones       String?
  motivoRechazo       String?
  revisadoPor         String?
  fechaRevision       DateTime?
  escaneoVirus        Boolean    @default(false)
  virusDetectado      Boolean    @default(false)
  nombreVirusDetectado String?
  
  documentoId   String
  documento     Documento  @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  
  estudianteId  String
  estudiante    Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime   @default(now())

  @@unique([documentoId, estudianteId])
  @@map("documentos_estudiante")
}

enum EstatusCreditoComplementario {
  PENDIENTE
  EN_REVISION
  VALIDADO
  RECHAZADO
}

enum TipoCreditoComplementario {
  ACTIVIDADES_EXTRACURRICULARES
  CURSOS
  TUTORIAS
  ACTIVIDADES_CULTURALES
}

model CreditoComplementario {
  id                       String                         @id @default(uuid())
  estudianteId             String
  estudiante               Estudiante                     @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  numero                   Int
  tipo                     TipoCreditoComplementario
  titulo                   String
  descripcion              String
  horasCurso               Int?
  horasTotales             Int?                           // Suma total de horas de todos los archivos
  estatus                  EstatusCreditoComplementario   @default(PENDIENTE)
  motivoRechazo            String?
  observaciones            String?
  archivoOriginal          String
  mimeTypeOriginal         String
  tamanoOriginal           Int
  hashOriginal             String?
  archivoCombinado         String?                        // PDF combinado para administradores (solo CURSOS con múltiples archivos)
  mimeTypeCombinado        String?
  tamanoCombinado          Int?
  hashCombinado            String?
  archivoValidacionGenerada String?
  archivoValidado          String?
  mimeTypeValidado         String?
  tamanoValidado           Int?
  hashValidado             String?
  revisadoPorId            String?
  revisadoPor              Usuario?                       @relation("CreditosRevisados", fields: [revisadoPorId], references: [id])
  fechaEnvio               DateTime                       @default(now())
  fechaRevision            DateTime?
  createdAt                DateTime                       @default(now())
  updatedAt                DateTime                       @updatedAt
  
  // Relación con archivos adicionales (para cursos con múltiples PDFs)
  archivosAdicionales      ArchivoCredito[]

  @@unique([estudianteId, numero])
  @@map("creditos_complementarios")
}

model ArchivoCredito {
  id                       String                         @id @default(uuid())
  creditoId                String
  credito                  CreditoComplementario           @relation(fields: [creditoId], references: [id], onDelete: Cascade)
  horas                    Int?                           // Horas de este archivo específico (solo para CURSOS)
  rutaArchivo              String
  mimeType                 String
  tamano                   Int
  hash                     String?
  nombreOriginal           String?
  createdAt                DateTime                       @default(now())

  @@map("archivos_credito")
}

// ==========================================
// MODELOS DE NOTIFICACIONES
// ==========================================

model Notificacion {
  id          String              @id @default(uuid())
  tipo        TipoNotificacion
  titulo      String
  mensaje     String
  leida       Boolean             @default(false)
  documentoId String?
  
  estudianteId String
  estudiante   Estudiante         @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime            @default(now())

  @@map("notificaciones")
}

enum TipoNotificacion {
  DOCUMENTO_APROBADO
  DOCUMENTO_RECHAZADO
  DOCUMENTO_PENDIENTE
  GENERAL
  CREDITO_SUBIDO
  CREDITO_VALIDADO
  CREDITO_RECHAZADO
  CREDITO_VALIDACION_GENERADA
  PRUEBA_MODELO_DUAL_SUBIDA
  PRUEBA_MODELO_DUAL_APROBADA
  PRUEBA_MODELO_DUAL_RECHAZADA
}

// ==========================================
// MODELOS DE AUDITORÍA
// ==========================================

model ActividadUsuario {
  id          String   @id @default(uuid())
  accion      String
  entidad     String?
  entidadId   String?
  descripcion String?
  ipAddress   String?
  userAgent   String?
  
  usuarioId   String
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@map("actividades_usuario")
}

// ==========================================
// MODELOS DE MODELO DUAL
// ==========================================

model PruebaModeloDual {
  id                  String                    @id @default(uuid())
  estudianteId        String
  estudiante          Estudiante                @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  
  estudianteModeloDualId String?
  estudianteModeloDual   EstudianteModeloDual?  @relation(fields: [estudianteModeloDualId], references: [id], onDelete: SetNull)
  
  tipoPrueba          TipoPruebaModeloDual
  nombrePrueba        String
  descripcion         String?
  fechaAplicacion     DateTime?
  fechaVencimiento    DateTime?
  
  // Archivos
  archivoOriginal     String
  mimeTypeOriginal    String
  tamanoOriginal      Int
  hashOriginal        String?
  
  // Resultados de la prueba
  resultado           String?                   // JSON con los resultados
  puntuacion          Float?
  interpretacion      String?
  recomendaciones     String?
  
  // Revisión administrativa
  estatus             EstatusPruebaModeloDual   @default(PENDIENTE)
  revisadoPorId       String?
  revisadoPor         Usuario?                  @relation("PruebasRevisadas", fields: [revisadoPorId], references: [id])
  fechaRevision       DateTime?
  observaciones       String?
  motivoRechazo       String?
  
  // Archivo validado/firmado
  archivoValidado     String?
  mimeTypeValidado    String?
  tamanoValidado      Int?
  hashValidado        String?
  
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt

  @@map("pruebas_modelo_dual")
}

enum TipoPruebaModeloDual {
  PSICOLOGICA
  APTITUDES
  PERSONALIDAD
  INTERESES_VOCACIONALES
  ORIENTACION_PROFESIONAL
  OTRA
}

enum EstatusPruebaModeloDual {
  PENDIENTE
  EN_REVISION
  APROBADA
  RECHAZADA
  VENCIDA
}

model FormatoModeloDual {
  id              String              @id @default(uuid())
  nombre          String
  descripcion     String?
  tipo            TipoFormatoModeloDual
  urlDescarga     String?             // URL de OneDrive o enlace directo
  qrCode          String?             // Código QR para acceso rápido
  archivoLocal    String?             // Si se sube directamente al servidor
  mimeType        String?
  tamano          Int?
  activo          Boolean             @default(true)
  orden           Int                 @default(0)
  
  creadoPorId     String
  creadoPor       Usuario            @relation("FormatosCreados", fields: [creadoPorId], references: [id])
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@map("formatos_modelo_dual")
}

enum TipoFormatoModeloDual {
  SOLICITUD_ADMISION
  RENOVACION
  CONVENIO
  CARTA_COMPROMISO
  FORMATO_EMPRESA
  OTRO
}

model ConvenioModeloDual {
  id              String              @id @default(uuid())
  nombreEmpresa   String
  razonSocial     String?
  contacto        String?
  email           String?
  telefono        String?
  direccion       String?
  sector          String?             // Sector industrial
  vigente         Boolean             @default(true)
  fechaInicio     DateTime?
  fechaFin        DateTime?
  descripcion     String?
  condiciones     String?             // Condiciones del convenio
  urlConvenio     String?             // URL al documento del convenio
  qrCode          String?             // QR para acceso rápido
  
  creadoPorId     String
  creadoPor       Usuario            @relation("ConveniosCreados", fields: [creadoPorId], references: [id])
  
  estudiantes     EstudianteModeloDual[]
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@map("convenios_modelo_dual")
}

model EstudianteModeloDual {
  id                  String              @id @default(uuid())
  estudianteId        String
  estudiante          Estudiante          @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  
  convenioId          String?
  convenio            ConvenioModeloDual? @relation(fields: [convenioId], references: [id])
  
  tipoIngreso         TipoIngresoModeloDual
  periodo             String              // Ej: "2025-2"
  estatus             EstatusEstudianteModeloDual @default(EN_PROCESO)
  
  // Documentos del proceso
  solicitudSubida     Boolean             @default(false)
  solicitudAprobada   Boolean             @default(false)
  convenioFirmado     Boolean             @default(false)
  cartaCompromiso     Boolean             @default(false)
  
  fechaInicio         DateTime?
  fechaFin            DateTime?
  observaciones       String?
  
  // Relación con pruebas
  pruebas             PruebaModeloDual[]
  
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@unique([estudianteId])
  @@map("estudiantes_modelo_dual")
}

enum TipoIngresoModeloDual {
  NUEVO_INGRESO
  RENOVACION
}

enum EstatusEstudianteModeloDual {
  EN_PROCESO
  DOCUMENTOS_PENDIENTES
  PRUEBAS_PENDIENTES
  CONVENIO_PENDIENTE
  APROBADO
  RECHAZADO
  FINALIZADO
}

