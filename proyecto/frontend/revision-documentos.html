<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revisi√≥n de Documentos - Sistema Universitario</title>
  <style>
    :root{
      --verde: #2E8B57;
      --verde-claro: #66BB6A;
      --verde-oscuro: #1E5E3C;
      --gris-claro: #F5F5F5;
      --gris-medio: #757575;
      --negro: #212121;
      --azul: #2196F3;
      --amarillo: #FFC107;
      --rojo: #EF5350;
      --blanco: #FFFFFF;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      margin:0;
      background:var(--gris-claro);
      color:var(--negro)
    }
    .container{
      max-width:1600px;
      margin:0 auto;
      padding:20px
    }
    .header{
      background:linear-gradient(135deg,var(--verde-oscuro),var(--verde));
      color:#fff;
      padding:20px 32px;
      border-radius:16px;
      margin-bottom:24px;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:16px
    }
    .header-left{
      display:flex;
      align-items:center;
      gap:16px
    }
    .logo{
      height:50px;
      width:auto;
      object-fit:contain
    }
    .header h1{
      margin:0;
      font-size:28px
    }
    .user-info{
      background:rgba(255,255,255,.15);
      padding:8px 16px;
      border-radius:8px;
      font-size:14px
    }
    .btn{
      padding:10px 18px;
      border:0;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      transition:all .2s;
      text-decoration:none;
      display:inline-block
    }
    .btn-primary{
      background:var(--blanco);
      color:var(--verde-oscuro)
    }
    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,.15)
    }
    .btn-danger{
      background:var(--rojo);
      color:var(--blanco)
    }
    .btn-danger:hover{
      background:#c62828
    }
    .filters{
      background:var(--blanco);
      border-radius:12px;
      padding:20px;
      margin-bottom:24px;
      box-shadow:0 2px 12px rgba(0,0,0,.08)
    }
    .filters-title{
      font-size:18px;
      font-weight:700;
      margin:0 0 16px;
      color:var(--verde-oscuro)
    }
    .filters-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px
    }
    .filter-group{
      display:flex;
      flex-direction:column;
      gap:4px
    }
    .filter-label{
      font-size:13px;
      font-weight:600;
      color:var(--gris-medio)
    }
    select,input{
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:8px;
      outline:0;
      transition:border .15s;
      background:var(--blanco);
      color:var(--negro)
    }
    select:focus,input:focus{
      border-color:var(--verde);
      box-shadow:0 0 0 3px rgba(46,139,87,.12)
    }
    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
      margin-bottom:24px
    }
    .stat-card{
      background:var(--blanco);
      padding:20px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      border-left:4px solid var(--verde)
    }
    .stat-card.pendiente{border-left-color:var(--amarillo)}
    .stat-card.revision{border-left-color:var(--azul)}
    .stat-card.aprobado{border-left-color:var(--verde-claro)}
    .stat-card.rechazado{border-left-color:var(--rojo)}
    .stat-label{
      font-size:13px;
      color:var(--gris-medio);
      text-transform:uppercase;
      letter-spacing:.5px;
      margin-bottom:4px
    }
    .stat-value{
      font-size:32px;
      font-weight:800;
      color:var(--negro)
    }
    .card{
      background:var(--blanco);
      border-radius:12px;
      padding:24px;
      box-shadow:0 2px 12px rgba(0,0,0,.08);
      margin-bottom:20px
    }
    .card-title{
      font-size:20px;
      font-weight:700;
      margin:0 0 16px;
      color:var(--verde-oscuro)
    }
    .alumno-item{
      background:#f8f9fa;
      border-radius:12px;
      padding:20px;
      margin-bottom:16px;
      border:2px solid #e9ecef;
      transition:all .2s
    }
    .alumno-item:hover{
      border-color:var(--verde);
      box-shadow:0 4px 12px rgba(46,139,87,.1)
    }
    .alumno-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      flex-wrap:wrap;
      gap:12px
    }
    .alumno-info{
      display:flex;
      align-items:center;
      gap:12px
    }
    .alumno-avatar{
      width:50px;
      height:50px;
      border-radius:50%;
      background:var(--verde);
      color:var(--blanco);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:20px
    }
    .alumno-datos h3{
      margin:0 0 4px;
      font-size:18px;
      color:var(--negro)
    }
    .alumno-datos p{
      margin:0;
      font-size:14px;
      color:var(--gris-medio)
    }
    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:600;
      text-transform:capitalize
    }
    .badge.pendiente{background:#fef3c7;color:#92400e}
    .badge.en-revision{background:#dbeafe;color:#1e40af}
    .badge.aprobado{background:#d1fae5;color:#065f46}
    .badge.rechazado{background:#fee2e2;color:#991b1b}
    .badge.necesita-revision{background:#ffe4e6;color:#be123c;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .documentos-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
      gap:12px;
      margin-top:12px
    }
    .documento-card{
      background:var(--blanco);
      border:1px solid #e9ecef;
      border-radius:8px;
      padding:12px;
      transition:all .2s
    }
    .documento-card:hover{
      border-color:var(--verde);
      box-shadow:0 2px 8px rgba(46,139,87,.15)
    }
    .documento-nombre{
      font-weight:600;
      font-size:14px;
      color:var(--negro);
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:6px
    }
    .documento-acciones{
      display:flex;
      gap:8px;
      margin-top:8px
    }
    .btn-small{
      padding:6px 12px;
      font-size:12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      transition:all .2s
    }
    .btn-aprobar{
      background:var(--verde-claro);
      color:var(--blanco);
      border:0
    }
    .btn-aprobar:hover{
      background:var(--verde)
    }
    .btn-rechazar{
      background:var(--rojo);
      color:var(--blanco);
      border:0
    }
    .btn-rechazar:hover{
      background:#c62828
    }
    .btn-ver{
      background:var(--azul);
      color:var(--blanco);
      border:0
    }
    .btn-ver:hover{
      background:#1976d2
    }
    .empty{
      text-align:center;
      padding:60px 20px;
      color:var(--gris-medio)
    }
    .empty-icon{
      font-size:64px;
      opacity:.3;
      margin-bottom:12px
    }
    .toast{
      position:fixed;
      bottom:20px;
      right:20px;
      background:var(--verde);
      color:#fff;
      padding:14px 20px;
      border-radius:8px;
      box-shadow:0 6px 20px rgba(0,0,0,.15);
      opacity:0;
      transform:translateY(10px);
      transition:all .3s;
      z-index:2000;
      max-width:400px
    }
    .toast.show{
      opacity:1;
      transform:translateY(0)
    }
    .toast.error{
      background:var(--rojo)
    }
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px
    }
    .modal.show{
      display:flex
    }
    .modal-content{
      background:var(--blanco);
      border-radius:12px;
      max-width:600px;
      width:100%;
      max-height:90vh;
      overflow:auto;
      box-shadow:0 20px 60px rgba(0,0,0,.3)
    }
    .modal-header{
      padding:20px 24px;
      border-bottom:1px solid #eee;
      display:flex;
      justify-content:space-between;
      align-items:center
    }
    .modal-title{
      font-size:20px;
      font-weight:700;
      margin:0;
      color:var(--verde-oscuro)
    }
    .modal-close{
      background:none;
      border:0;
      font-size:24px;
      cursor:pointer;
      color:var(--gris-medio);
      padding:0;
      width:32px;
      height:32px;
      border-radius:50%;
      transition:background .15s
    }
    .modal-close:hover{
      background:#f0f0f0
    }
    .modal-body{
      padding:24px
    }
    textarea{
      width:100%;
      padding:12px;
      border:1px solid #ddd;
      border-radius:8px;
      outline:0;
      resize:vertical;
      min-height:100px;
      font-family:inherit
    }
    textarea:focus{
      border-color:var(--verde);
      box-shadow:0 0 0 3px rgba(46,139,87,.12)
    }
    @media (max-width: 768px){
      .header{
        flex-direction:column;
        align-items:flex-start
      }
      .filters-grid{
        grid-template-columns:1fr
      }
      .documentos-grid{
        grid-template-columns:1fr
      }
    }
  </style>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Crect width='100%25' height='100%25' rx='24' fill='%232E8B57'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='64' fill='white'%3EU%3C/text%3E%3C/svg%3E"/>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <img src="../img/Logo.png" alt="Logo" class="logo" onerror="this.style.display='none'">
        <div>
          <h1>üìã Revisi√≥n de Documentos</h1>
          <p style="margin:4px 0 0;opacity:.9">Gesti√≥n de documentos de alumnos</p>
        </div>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div class="user-info" id="user-info">Cargando...</div>
        <button class="btn btn-primary" onclick="location.href='dashboard-admin.html'">‚Üê Dashboard</button>
        <button class="btn btn-danger" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card pendiente">
        <div class="stat-label">Pendientes</div>
        <div class="stat-value" id="stat-pendientes">0</div>
      </div>
      <div class="stat-card revision">
        <div class="stat-label">En Revisi√≥n</div>
        <div class="stat-value" id="stat-revision">0</div>
      </div>
      <div class="stat-card aprobado">
        <div class="stat-label">Aprobados</div>
        <div class="stat-value" id="stat-aprobados">0</div>
      </div>
      <div class="stat-card rechazado">
        <div class="stat-label">Rechazados</div>
        <div class="stat-value" id="stat-rechazados">0</div>
      </div>
    </div>

    <div class="filters">
      <h2 class="filters-title">üîç Filtros</h2>
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Programa/Carrera</label>
          <select id="filter-programa" onchange="aplicarFiltros()">
            <option value="">Todos los programas</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Semestre</label>
          <select id="filter-semestre" onchange="aplicarFiltros()">
            <option value="">Todos los semestres</option>
            <option value="1">1er Semestre</option>
            <option value="2">2do Semestre</option>
            <option value="3">3er Semestre</option>
            <option value="4">4to Semestre</option>
            <option value="5">5to Semestre</option>
            <option value="6">6to Semestre</option>
            <option value="7">7mo Semestre</option>
            <option value="8">8vo Semestre</option>
            <option value="9">9no Semestre</option>
            <option value="10">10mo Semestre</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Estado</label>
          <select id="filter-estado" onchange="aplicarFiltros()">
            <option value="">Todos los estados</option>
            <option value="pendiente">Pendiente</option>
            <option value="en_revision">En Revisi√≥n</option>
            <option value="aprobado">Aprobado</option>
            <option value="rechazado">Rechazado</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Buscar alumno</label>
          <input type="text" id="filter-buscar" placeholder="Nombre o matr√≠cula..." onkeyup="aplicarFiltros()">
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">üë• Alumnos y Documentos</h2>
      <div id="alumnos-container">
        <div class="empty">
          <div class="empty-icon">üì≠</div>
          <div>Cargando alumnos...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Rechazo -->
  <div class="modal" id="modal-rechazo">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Rechazar Documento</h3>
        <button class="modal-close" onclick="cerrarModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p style="margin:0 0 12px;color:var(--gris-medio)">Indica el motivo del rechazo:</p>
        <textarea id="motivo-rechazo" placeholder="Ejemplo: El documento no es legible, falta informaci√≥n, etc."></textarea>
        <div style="display:flex;gap:12px;margin-top:16px">
          <button class="btn btn-danger" onclick="confirmarRechazo()">Rechazar</button>
          <button class="btn btn-primary" onclick="cerrarModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API = 'http://localhost:4000';
    let accessToken = localStorage.getItem('accessToken') || '';
    let usuario = null;
    let alumnosData = [];
    let documentoSeleccionado = null;

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (type === 'error' ? ' error' : '');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Verificar autenticaci√≥n
    (async () => {
      if (!accessToken) {
        showToast('Debes iniciar sesi√≥n primero', 'error');
        setTimeout(() => location.href = 'auth-test.html', 2000);
        return;
      }

      const usuarioStr = localStorage.getItem('usuario');
      if (usuarioStr) {
        usuario = JSON.parse(usuarioStr);
        
        // Verificar que sea admin o docente
        if (usuario.tipo !== 'admin' && usuario.tipo !== 'docente') {
          showToast('No tienes permisos para acceder a esta secci√≥n', 'error');
          setTimeout(() => location.href = 'dashboard-alumno.html', 2000);
          return;
        }

        const rolesText = usuario.roles ? usuario.roles.join(', ') : 'Usuario';
        document.getElementById('user-info').textContent = `${usuario.nombre} - ${rolesText}`;
      }

      await cargarProgramas();
      await cargarAlumnos();
    })();

    async function call(path, method = 'GET', body = null) {
      try {
        const res = await fetch(API + path, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken
          },
          body: body ? JSON.stringify(body) : undefined
        });
        
        if (res.status === 401) {
          showToast('Sesi√≥n expirada. Redirigiendo...', 'error');
          setTimeout(() => location.href = 'auth-test.html', 2000);
          return null;
        }
        
        const text = await res.text();
        try {
          return { ok: res.ok, status: res.status, data: JSON.parse(text) };
        } catch {
          return { ok: res.ok, status: res.status, data: text };
        }
      } catch (error) {
        console.error('Error en la petici√≥n:', error);
        showToast('Error de conexi√≥n con el servidor', 'error');
        return null;
      }
    }

    async function cargarProgramas() {
      const res = await call('/catalogos/programas');
      if (res?.ok && res.data) {
        const select = document.getElementById('filter-programa');
        res.data.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = `${p.nombre} (${p.departamento})`;
          select.appendChild(option);
        });
      }
    }

    async function cargarAlumnos() {
      const res = await call('/alumnos');
      
      if (!res || !res.ok) {
        document.getElementById('alumnos-container').innerHTML = '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div>Error al cargar alumnos</div></div>';
        return;
      }

      alumnosData = res.data || [];
      
      // Cargar documentos de cada alumno
      for (let alumno of alumnosData) {
        const docsRes = await call(`/alumnos/${alumno.id}/tramites`);
        alumno.documentos = docsRes?.ok ? docsRes.data : [];
      }

      renderizarAlumnos(alumnosData);
      actualizarEstadisticas(alumnosData);
    }

    function renderizarAlumnos(alumnos) {
      const container = document.getElementById('alumnos-container');
      
      if (alumnos.length === 0) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><div>No hay alumnos para mostrar</div></div>';
        return;
      }

      container.innerHTML = alumnos.map(alumno => {
        const iniciales = `${alumno.nombre[0]}${alumno.apellidos[0]}`;
        const necesitaRevision = alumno.documentos && alumno.documentos.some(d => d.estatus === 'pendiente' || d.estatus === 'en_revision');
        
        return `
          <div class="alumno-item">
            <div class="alumno-header">
              <div class="alumno-info">
                <div class="alumno-avatar">${iniciales}</div>
                <div class="alumno-datos">
                  <h3>${alumno.nombre} ${alumno.apellidos}</h3>
                  <p>
                    Matr√≠cula: <strong>${alumno.matricula}</strong> | 
                    ${alumno.programa} | 
                    Semestre: <strong>${alumno.semestre || 'N/A'}</strong>
                  </p>
                </div>
              </div>
              ${necesitaRevision ? '<span class="badge necesita-revision">üîî Necesita Revisi√≥n</span>' : ''}
            </div>
            
            <div class="documentos-grid" id="docs-alumno-${alumno.id}">
              <!-- Documentos simulados -->
              <div class="documento-card">
                <div class="documento-nombre">üìù Solicitud</div>
                <span class="badge en-revision">En Revisi√≥n</span>
                <div class="documento-acciones">
                  <button class="btn-small btn-ver" onclick="verDocumento(${alumno.id}, 'solicitud')">üëÅÔ∏è Ver</button>
                  <button class="btn-small btn-aprobar" onclick="aprobarDocumento(${alumno.id}, 'solicitud')">‚úì Aprobar</button>
                  <button class="btn-small btn-rechazar" onclick="rechazarDocumento(${alumno.id}, 'solicitud')">‚úó Rechazar</button>
                </div>
              </div>
              
              <div class="documento-card">
                <div class="documento-nombre">üìä K√°rdex</div>
                <span class="badge pendiente">Pendiente</span>
                <div class="documento-acciones">
                  <button class="btn-small btn-ver" disabled style="opacity:.5;cursor:not-allowed">üëÅÔ∏è Ver</button>
                  <button class="btn-small btn-aprobar" disabled style="opacity:.5;cursor:not-allowed">‚úì Aprobar</button>
                  <button class="btn-small btn-rechazar" disabled style="opacity:.5;cursor:not-allowed">‚úó Rechazar</button>
                </div>
              </div>
              
              <div class="documento-card">
                <div class="documento-nombre">üí≥ Comprobante de Pago</div>
                <span class="badge aprobado">Aprobado</span>
                <div class="documento-acciones">
                  <button class="btn-small btn-ver" onclick="verDocumento(${alumno.id}, 'pago')">üëÅÔ∏è Ver</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function aplicarFiltros() {
      const programaId = document.getElementById('filter-programa').value;
      const semestre = document.getElementById('filter-semestre').value;
      const estado = document.getElementById('filter-estado').value;
      const buscar = document.getElementById('filter-buscar').value.toLowerCase();

      let filtrados = alumnosData.filter(alumno => {
        if (programaId && alumno.programa_id != programaId) return false;
        if (semestre && alumno.semestre != semestre) return false;
        if (buscar && !(alumno.nombre.toLowerCase().includes(buscar) || 
                        alumno.apellidos.toLowerCase().includes(buscar) ||
                        alumno.matricula.toLowerCase().includes(buscar))) return false;
        return true;
      });

      renderizarAlumnos(filtrados);
      actualizarEstadisticas(filtrados);
    }

    function actualizarEstadisticas(alumnos) {
      let pendientes = 0, revision = 0, aprobados = 0, rechazados = 0;
      
      // Estad√≠sticas simuladas
      document.getElementById('stat-pendientes').textContent = Math.floor(alumnos.length * 0.3);
      document.getElementById('stat-revision').textContent = Math.floor(alumnos.length * 0.4);
      document.getElementById('stat-aprobados').textContent = Math.floor(alumnos.length * 0.2);
      document.getElementById('stat-rechazados').textContent = Math.floor(alumnos.length * 0.1);
    }

    function verDocumento(alumnoId, tipo) {
      showToast('Funci√≥n de visualizaci√≥n en desarrollo');
    }

    function aprobarDocumento(alumnoId, tipo) {
      if (confirm('¬øEst√°s seguro de aprobar este documento?')) {
        showToast('Documento aprobado correctamente');
        setTimeout(() => cargarAlumnos(), 1000);
      }
    }

    function rechazarDocumento(alumnoId, tipo) {
      documentoSeleccionado = { alumnoId, tipo };
      document.getElementById('modal-rechazo').classList.add('show');
    }

    function cerrarModal() {
      document.getElementById('modal-rechazo').classList.remove('show');
      document.getElementById('motivo-rechazo').value = '';
      documentoSeleccionado = null;
    }

    function confirmarRechazo() {
      const motivo = document.getElementById('motivo-rechazo').value.trim();
      
      if (!motivo) {
        showToast('Debes indicar el motivo del rechazo', 'error');
        return;
      }

      showToast('Documento rechazado. Se notificar√° al alumno.');
      cerrarModal();
      setTimeout(() => cargarAlumnos(), 1000);
    }

    function cerrarSesion() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      localStorage.removeItem('usuario');
      showToast('Sesi√≥n cerrada correctamente');
      setTimeout(() => location.href = 'auth-test.html', 1000);
    }
  </script>
</body>
</html>
